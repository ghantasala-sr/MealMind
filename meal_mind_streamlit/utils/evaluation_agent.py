import json
import streamlit as st
import warnings
from typing import Dict, Any, Optional
from langchain_community.chat_models import ChatSnowflakeCortex

# Suppress the specific warning from ChatSnowflakeCortex about default parameters
warnings.filterwarnings("ignore", message=".*is not default parameter.*")
from langchain.schema import SystemMessage, HumanMessage

class NutritionEvaluationAgent:
    """
    Agent to verify nutrition data accuracy using Snowflake Cortex Search.
    It compares the generated JSON against ground truth data found via Cortex.
    """
    
    def __init__(self, session):
        self.session = session
        try:
            # Initialize Cortex LLM with Search Service
            self.llm = ChatSnowflakeCortex(
                session=self.session,
                model="llama3.1-70b",
                cortex_search_service="MEAL_MIND" # Assuming this service indexes the USDA/Nutrition DB
            )
        except Exception as e:
            st.warning(f"Evaluation Agent init failed: {e}")
            self.llm = None

    def evaluate_nutrition(self, food_name: str, generated_json: Dict[str, Any]) -> Dict[str, Any]:
        """
        Evaluate if the generated nutrition data is accurate.
        
        Args:
            food_name: Name of the food item (e.g., "Peanut butter cookie")
            generated_json: The JSON generated by the MealAdjustmentAgent
            
        Returns:
            Dict with keys: 'verdict' (CORRECT/INCORRECT), 'explanation', 'ground_truth'
        """
        if not self.llm:
            return {"verdict": "ERROR", "explanation": "Agent offline", "ground_truth": None}

        # Extract nutrition from the generated JSON
        gen_nutrition = generated_json.get('nutrition', {})
        
        system_prompt = f"""You are a Nutrition Verification Judge.
        
        Your Goal: Verify if the nutrition data generated for "{food_name}" is accurate.
        
        1. SEARCH: Use your knowledge and the Cortex Search tool to find the standard nutritional value for "{food_name}".
        2. COMPARE: Compare the standard values with the GENERATED values provided below.
        3. VERDICT: 
           - If values are within reasonable range (+/- 20%), verdict is CORRECT.
           - If values are significantly off, verdict is INCORRECT.
           
        GENERATED DATA:
        {json.dumps(gen_nutrition, indent=2)}
        
        OUTPUT FORMAT:
        Return a JSON object:
        {{
            "verdict": "CORRECT" or "INCORRECT",
            "explanation": "Brief explanation of discrepancies or confirmation.",
            "ground_truth": {{
                "calories": 0,
                "protein_g": 0,
                "carbohydrates_g": 0,
                "fat_g": 0
            }}
        }}
        """
        
        try:
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=f"Verify nutrition for: {food_name}")
            ]
            
            response = self.llm.invoke(messages)
            content = response.content.strip()
            
            # Clean JSON
            if "```" in content:
                content = content.split("```")[1]
                if content.startswith("json"):
                    content = content[4:]
            
            result = json.loads(content.strip())
            return result
            
        except Exception as e:
            return {
                "verdict": "ERROR", 
                "explanation": f"Evaluation failed: {str(e)}", 
                "ground_truth": None
            }
